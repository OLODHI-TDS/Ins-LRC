# Salesforce Deployment Pipeline - Dev
# Deploys to OmarDev sandbox on push to dev branch

name: SF Deploy to Dev

on:
  push:
    branches:
      - dev
    paths:
      - 'salesforce/**'
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    name: Deploy to OmarDev Sandbox
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: salesforce

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Salesforce CLI
        working-directory: .
        run: |
          npm install -g @salesforce/cli
          sf --version

      - name: Authenticate to Salesforce
        env:
          SFDX_AUTH_URL: ${{ secrets.SFDX_AUTH_URL_DEV }}
        run: |
          echo "$SFDX_AUTH_URL" > auth_url.txt
          sf org login sfdx-url --sfdx-url-file auth_url.txt --alias omardev --set-default
          rm auth_url.txt

      - name: Check for deployable metadata
        id: check-metadata
        run: |
          # Count files excluding .gitkeep
          METADATA_COUNT=$(find force-app -type f ! -name ".gitkeep" | wc -l)
          echo "metadata_count=$METADATA_COUNT" >> $GITHUB_OUTPUT
          if [ "$METADATA_COUNT" -eq 0 ]; then
            echo "No Salesforce metadata to deploy"
          else
            echo "Found $METADATA_COUNT metadata files to deploy"
          fi

      - name: Validate deployment (dry run)
        if: steps.check-metadata.outputs.metadata_count != '0'
        run: |
          sf project deploy start \
            --source-dir force-app \
            --target-org omardev \
            --dry-run \
            --ignore-conflicts

      - name: Deploy to Salesforce
        if: steps.check-metadata.outputs.metadata_count != '0'
        run: |
          sf project deploy start \
            --source-dir force-app \
            --target-org omardev \
            --ignore-conflicts

      - name: Run Apex Tests (if any)
        run: |
          # Only run if there are test classes
          TEST_CLASSES=$(find force-app -name "*Test.cls" -o -name "*_Test.cls" | wc -l)
          if [ "$TEST_CLASSES" -gt 0 ]; then
            sf apex run test --target-org omardev --wait 10 --result-format human
          else
            echo "No test classes found, skipping tests"
          fi
        continue-on-error: true
